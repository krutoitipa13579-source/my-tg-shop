from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
import json
from datetime import datetime
import os
import asyncio
from aiohttp import web

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
BOT_TOKEN = os.getenv('BOT_TOKEN', '8290686679:AAFt8_v9X_yzeLeOhjhlk4B-eirYOGOsT5Q')
ADMIN_CHAT_ID = os.getenv('ADMIN_CHAT_ID', '5127569065')
PORT = int(os.getenv('PORT', 10000))

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
app = None
bot_app = None

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    shop_url = "https://my-tg-shop.onrender.com"
    
    keyboard = [[
        InlineKeyboardButton("ğŸ›ï¸ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½", web_app=WebAppInfo(url=shop_url))
    ]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        'ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² ABKSWAGG!\n\n'
        'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ½Ğ°Ñˆ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ ÑÑ‚Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ğ´ĞµĞ¶Ğ´Ñ‹.',
        reply_markup=reply_markup
    )

async def handle_web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        data = json.loads(update.effective_message.web_app_data.data)
        await process_order(data, update.effective_user)
        await update.message.reply_text("âœ… Ğ—Ğ°ĞºĞ°Ğ· Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ!")
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")
        await update.message.reply_text("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°.")

async def process_order(data, user):
    order_text = format_order_text(data, user)
    await bot_app.bot.send_message(chat_id=ADMIN_CHAT_ID, text=order_text, parse_mode='HTML')

def format_order_text(data, user):
    order_text = f"""
ğŸ›’ <b>ĞĞĞ’Ğ«Ğ™ Ğ—ĞĞšĞĞ— Ğ˜Ğ— ĞœĞĞ“ĞĞ—Ğ˜ĞĞ!</b>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‘¤ <b>ĞšĞ»Ğ¸ĞµĞ½Ñ‚:</b> {data.get('customerName', 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾')}
ğŸ“ <b>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:</b> <code>{data.get('customerPhone', 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}</code>
ğŸ  <b>ĞĞ´Ñ€ĞµÑ:</b> {data.get('shippingAddress', 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}

ğŸ†” <b>ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:</b> <code>{user.id}</code>
ğŸ‘¤ <b>Username:</b> @{user.username if user.username else 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½'}
ğŸ“… <b>Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}

ğŸ“¦ <b>Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ·Ğ°ĞºĞ°Ğ·Ğ°:</b>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
    
    for i, item in enumerate(data.get('products', []), 1):
        order_text += f"""
{i}. <b>{item['name']}</b>
   â€¢ Ğ Ğ°Ğ·Ğ¼ĞµÑ€: {item.get('size', 'ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½')}
   â€¢ Ğ¦ĞµĞ½Ğ°: {item['price']} Ñ€ÑƒĞ±.
   â€¢ ĞšĞ¾Ğ»-Ğ²Ğ¾: {item.get('quantity', 1)}
   â€¢ Ğ¡ÑƒĞ¼Ğ¼Ğ°: {item['price'] * item.get('quantity', 1)} Ñ€ÑƒĞ±.
"""
    
    order_text += f"""
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’µ <b>ĞĞ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°: {data['totalAmount']} Ñ€ÑƒĞ±.</b>

â° <b>Ğ’Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""
    return order_text

async def handle_webhook(request):
    try:
        data = await request.json()
        await process_order(data, type('User', (), {'id': 'WEB', 'username': 'website'}))
        return web.Response(text='OK')
    except Exception as e:
        print(f"Webhook error: {e}")
        return web.Response(text='ERROR', status=500)

async def health_check(request):
    return web.Response(text='Bot is running!')

async def main():
    global bot_app, app
    
    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°
    bot_app = Application.builder().token(BOT_TOKEN).build()
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
    bot_app.add_handler(CommandHandler("start", start))
    bot_app.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_web_app_data))
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    await bot_app.initialize()
    await bot_app.start()
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ HTTP ÑĞµÑ€Ğ²ĞµÑ€
    app = web.Application()
    app.router.add_post('/webhook', handle_webhook)
    app.router.add_get('/health', health_check)
    
    runner = web.AppRunner(app)
    await runner.setup()
    
    site = web.TCPSite(runner, '0.0.0.0', PORT)
    await site.start()
    
    print(f"âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ {PORT}")
    print("ğŸŒ Webhook: /webhook")
    
    # Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»
    await asyncio.Future()

if __name__ == '__main__':
    asyncio.run(main())
